#!groovy

@Library("Infrastructure")

//import uk.gov.hmcts.contino.AppPipelineConfig


def type = "java"
def product = "am"
def component = "lib-test"


/*def secretId = "am-lib-test-${params.ENVIRONMENT}"
def secrets = [
  (secretId): [
    secret('am-lib-test-POSTGRES-HOST', 'DATABASE_HOST'),
    secret('am-lib-test-POSTGRES-PORT', 'DATABASE_PORT'),
    secret('am-lib-test-POSTGRES-DATABASE', 'DATABASE_NAME'),
    secret('am-lib-test-POSTGRES-USER', 'DATABASE_USER'),
    secret('am-lib-test-POSTGRES-PASS', 'DATABASE_PASS')
  ]
]


static Map<String, Object> secret(String secretName, String envVariable) {
  [$class     : 'AzureKeyVaultSecret',
   secretType : 'Secret',
   name       : secretName,
   envVariable: envVariable
  ]
}*/


/*def subscription = "nonprod"
def config = new AppPipelineConfig()
config.vaultSecrets = secrets*/

def DATABASE_HOST = 'am-lib-test-POSTGRES-HOST'
def DATABASE_PORT = 'am-lib-test-POSTGRES-PORT'
def DATABASE_NAME = 'am-lib-test-POSTGRES-DATABASE'
def DATABASE_USER = 'am-lib-test-POSTGRES-USER'
def DATABASE_PASS = 'am-lib-test-POSTGRES-PASS'



withPipeline(type, product, component) {
  setVaultName('am-lib-test')

  enableDockerBuild()
  installCharts()
  enableDbMigration()

  before('functionalTest:preview') {
    sh "echo 'insert functional test data'"


    withDocker('jbergknoff/postgresql-client', "--entrypoint='' -e PGPASSWORD=${DATABASE_PASS} -v ${WORKSPACE}/nightlyperformancedata/:/nightlyperformancedata") {
      sh "chmod +x /nightlyperformancedata/load-or-delete-performance-testdata.sh"
      sh "/nightlyperformancedata/load-or-delete-performance-testdata.sh \
                        ${WORKSPACE} \
                        'load' \
                        ${DATABASE_USER} \
                        ${DATABASE_NAME} \
                        ${DATABASE_HOST} \
                        ${DATABASE_PASS} \
                        ${DATABASE_PORT} \
                        'aks'"
    }



    print "done functional test data insertion"
  }

  after('functionalTest:preview') {
    sh "echo 'delete functional test data'"
//    withSubscription(subscription) {
//      withTeamSecrets(config, params.ENVIRONMENT) {
    sh "./gradlew deletePerformanceTestData -PENVIRONMENT='aks' "
//      }
//    }
    print "done functional test deletion"
  }

  onMaster {
    enableSlackNotifications('#am-master-builds')

    before('aat:promotion') {
      withCredentials([usernamePassword(credentialsId: 'jenkins-github-hmcts-api-token', usernameVariable: 'USERNAME', passwordVariable: 'BEARER_TOKEN')]) {
        sh '''
          set -e

          function publish {
            git config user.email "jenkins@local"
            git config user.name "Jenkins"
            git remote set-url origin $(git config remote.origin.url | sed "s/github.com/${BEARER_TOKEN}@github.com/g")

            git checkout --orphan gh-pages
            git add javadoc/
            git commit -m "docs: add latest version of Javadoc" javadoc/
            git push --force origin gh-pages
          }

          cp -r am-lib/build/docs/javadoc . && publish && rm -rf javadoc/
        '''
      }
    }

    after('smoketest:aat') {
      echo "Disabling prod build"
      sh "rm -rf infrastructure/"
    }
  }

  onPR {

    // channel won't be used instead the user channel configured here is used:
    // https://github.com/hmcts/github-slack-user-mappings
    enableSlackNotifications('#am-pr-builds')
  }
}
